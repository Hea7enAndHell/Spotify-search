"use strict";const login=document.getElementById("login"),loginButton=document.getElementById("login-button"),loginDescription=document.querySelector(".login__description"),logoutButton=document.getElementById("logout"),page=document.querySelector(".page"),header=document.querySelector(".header"),aside=document.querySelector(".aside"),asideContent=document.querySelector(".aside-content"),main=document.querySelector(".main"),footer=document.querySelector(".footer"),user=document.querySelector(".user__button"),playlistList=document.querySelector(".playlist-songs__list"),viewCompactButton=document.querySelector(".view__compact-button"),viewListButton=document.querySelector(".view__list-button"),sortButton=document.querySelector(".sort__button"),sortContentPopup=document.querySelector(".sort-content"),sortContentButtons=document.querySelectorAll(".sort-content__button"),sortContentButtonDefault=document.querySelector(".sort-content__button[data-sort-default]"),sortContentButtonDate=document.querySelector(".sort-content__button[data-sort-date]"),sortContentButtonName=document.querySelector(".sort-content__button[data-sort-name]"),scrollUpButton=document.querySelector(".scroll-up-button"),headerPlaylistName=document.querySelector(".header__playlist-name"),headerPlaylistSongsAmount=document.querySelector(".header__playlist-songs-amount"),libraryOtherPlaylistsText=document.querySelector(".library__other-playlists-text"),libraryOtherPlaylistsList=document.querySelector(".library__other-playlists-list"),likedSongsButton=document.querySelector(".library__liked-songs-button");let sortArray=[],sortDefaultArray=[],touchStartX=0,checkPlaylistButton=!1;function mediaWidth(t){const e=1.6*parseFloat(window.getComputedStyle(document.documentElement).fontSize);return t=parseFloat(t)/16*10,Math.floor(t*Math.floor(e))}function openAside(){aside.classList.add("active"),aside.classList.remove("aside-swipe-animation"),document.body.classList.add("no-scroll"),page.classList.add("backdrop");for(const t of page.children)t.classList.contains("aside")||t.setAttribute("inert","")}function closesAside(){aside.classList.remove("active"),document.body.classList.remove("no-scroll"),page.classList.remove("backdrop");for(const t of page.children)t.classList.contains("aside")||t.removeAttribute("inert")}function setLocalStorage(t,e){localStorage.setItem(t,JSON.stringify(e))}function getLocalStorage(t){if(localStorage.getItem(t))return JSON.parse(localStorage.getItem(t))}window.addEventListener("resize",(()=>{main.style.marginTop=header.offsetHeight+"px",sortContentPopup.classList.contains("active")&&sortContentPopup.classList.remove("active"),window.innerWidth>mediaWidth("107rem")&&aside.classList.contains("active")&&closesAside()})),window.addEventListener("scroll",(()=>{sortContentPopup.classList.contains("active")&&sortContentPopup.classList.remove("active"),window.scrollY>=100?(scrollUpButton.classList.add("active"),scrollUpButton.removeAttribute("disabled"),scrollUpButton.removeAttribute("aria-disabled")):(scrollUpButton.classList.remove("active"),scrollUpButton.setAttribute("disabled",""),scrollUpButton.setAttribute("aria-disabled","true"))})),scrollUpButton.addEventListener("click",(()=>{window.scrollTo({top:0,behavior:"smooth"})})),document.addEventListener("click",(t=>{sortContentPopup.classList.contains("active")&&sortContentPopup.classList.remove("active"),window.innerWidth<=mediaWidth("107rem")&&aside.classList.contains("active")&&(!t.target.closest(".aside")||t.target.closest("button"))&&closesAside()})),user.addEventListener("click",(t=>{t.stopPropagation(),sortContentPopup.classList.contains("active")&&sortContentPopup.classList.remove("active"),window.innerWidth<=mediaWidth("107rem")&&(aside.classList.toggle("active")?openAside():closesAside())})),sortButton.addEventListener("click",(t=>{t.stopPropagation(),window.innerWidth<=mediaWidth("107rem")&&aside.classList.contains("active")&&closesAside(),sortContentPopup.classList.toggle("active"),sortContentPopup.style.top=sortButton.getBoundingClientRect().top+"px",sortContentPopup.style.left=sortButton.offsetWidth+sortButton.getBoundingClientRect().left+10+"px"})),sortContentPopup.addEventListener("click",(t=>{t.stopPropagation()})),asideContent.addEventListener("scroll",(()=>{sortContentPopup.classList.remove("active")})),aside.addEventListener("touchstart",(t=>{window.innerWidth<=mediaWidth("107rem")&&!aside.classList.contains("active")&&(touchStartX=t.changedTouches[0].screenX)})),aside.addEventListener("touchmove",(t=>{sortContentPopup.classList.contains("active")&&sortContentPopup.classList.remove("active"),window.innerWidth<=mediaWidth("107rem")&&!aside.classList.contains("active")&&t.changedTouches[0].screenX>touchStartX+60&&openAside()})),viewCompactButton.addEventListener("click",(()=>{viewCompactButton.classList.contains("active")||(viewCompactButton.classList.add("active"),viewListButton.classList.remove("active"),playlistList.classList.remove("view-list"))})),viewListButton.addEventListener("click",(()=>{viewListButton.classList.contains("active")||(viewListButton.classList.add("active"),viewCompactButton.classList.remove("active"),playlistList.classList.add("view-list"))}));const clientId="98f436cbfd3a4a6bb6ad4fda6427b451",redirectUri="https://hea7enandhell.github.io/Spotify-search/",scopes="user-library-read user-read-private user-read-email playlist-read-private playlist-read-collaborative";function getAccessToken(){const t=window.location.hash;let e=getLocalStorage("accessToken");return t&&(e=new URLSearchParams(t.substring(1)).get("access_token"),setLocalStorage("accessToken",e),window.location.hash=""),e}async function fetchWebApi(t,e){const s=await fetch(`https://api.spotify.com/v1/${e}`,{method:"GET",headers:{Authorization:`Bearer ${t}`}});return 401===s.status?(loginDescription.textContent="Please sign in again",aside.classList.add("hidden"),header.classList.add("hidden"),main.classList.add("hidden"),footer.classList.add("hidden"),login.classList.remove("hidden"),!1):s}async function getUserProfile(t){const e=await fetchWebApi(t,"me");if(!1===e)return!1;const s=await e.json();return{userName:s.display_name,userImage:s.images[1]?`<img src="${s.images[1].url}" alt="User image" class="user__image">`:null}}async function getPlaylistTracks(t,e="me",s=0,o=50){const a=await fetchWebApi(t,`${e}/tracks?offset=${s}&limit=${o}`);if(!1===a)return;const n=await a.json(),i={number:s,totalTracks:n.total,tracks:n.items};if(header.classList.contains("hidden")&&(headerPlaylistSongsAmount.textContent=n.total,header.classList.remove("hidden"),main.style.marginTop=header.offsetHeight+"px",main.classList.remove("hidden"),footer.classList.remove("hidden")),renderTrackList(i),!(n.total<=s+o))return getPlaylistTracks(t,e,s+o,o);checkPlaylistButton=!0}async function getUserPlaylists(t){const e=await fetchWebApi(t,"me/playlists?limit=50");if(!1===e)return;const s=await e.json();s.total<1?libraryOtherPlaylistsText.textContent="No playlists":(libraryOtherPlaylistsText.remove(),s.items.forEach((t=>{libraryOtherPlaylistsList.insertAdjacentHTML("beforeend",renderPlaylistButton(t))})))}async function getUserPlaylistTracks(t,e){const s=await fetchWebApi(t,`playlists/${e}/tracks?limit=50`);if(!1!==s)return await s.json()}function msToHhMmSs(t){const e=Math.round(t/1e3%60).toString().padStart(2,"0"),s=Math.floor(t/6e4%60).toString().padStart(2,"0"),o=Math.floor(t/36e5%24).toString().padStart(2,"0");return`${"00"!==o?o+":":""}${s}:${e}`}function trackNameToLink(t,e){const s=`${t.replace(/,/g,"")} ${e.replace(/,/g,"")} download`;return`https://www.google.com.ua/search?q=${encodeURIComponent(s)}`}function renderTrackList({totalTracks:t,tracks:e,number:s}){e.forEach((({added_at:e,track:o},a)=>{const n={trackAdded:e,trackNumber:(s+a+1).toString().padStart(t.toString().length,"0"),trackArtists:o.artists.map((t=>t.name)).join(", "),trackName:o.name,trackImage:o.album.images[1].url,trackDuration:msToHhMmSs(o.duration_ms)};sortArray.push(n),sortDefaultArray.push(n),playlistList.insertAdjacentHTML("beforeend",renderTrack(n))}))}function renderTrack({trackNumber:t,trackImage:e,trackDuration:s,trackArtists:o,trackName:a}){return`\n        <li class="playlist-songs__item">\n            <div class="playlist-songs__image-wrap">\n                <img class="playlist-songs__image"\n                    src="${e}" alt="Image" loading="lazy">\n            </div>\n            <div class="playlist-songs__item-content">\n                <div class="playlist-songs__number-wrap">\n                    <p class="playlist-songs__number">${t}</p>\n                    <p class="playlist-songs__duration">${s}</p>\n                </div>\n                <div class="playlist-songs__song">\n                    <p class="playlist-songs__song-artists">${o}</p>\n                    <p class="playlist-songs__song-title">${a}</p>\n                </div>\n                <a href="${trackNameToLink(o,a)}"\n                    target="_blank" class="playlist-songs__link" aria-label="search ${o} ${a}">Search</a>\n            </div>\n        </li>\n    `}function renderPlaylistButton({id:t,images:e,name:s}){return`\n        <li class="library__other-playlists-item">\n            <button type="button" class="library__playlist-button" data-playlist-id="${t}">\n                ${e?`<img src="${e[0].url}" alt="Image" class="library__playlist-image">`:'<picture>\n                                <source srcset="./images/music-note.avif" type="image/avif">\n                                <source srcset="./images/music-note.webp" type="image/webp">\n                                <img src="./images/music-note.png" alt="Image" class="library__playlist-image">\n                            </picture>'}\n                <h4 class="library__playlist-name">${s}</h4>\n            </button>\n        </li>\n    `}function sortButtonAction(t,e){if(!checkPlaylistButton)return;const s=t.classList.contains("active");s||(sortContentButtons.forEach((t=>{t.classList.remove("active","reverse")})),t.classList.add("active")),s&&t.classList.toggle("reverse"),sortArray.sort(e);t.classList.contains("reverse")&&sortArray.reverse(),updatePlaylistList(sortArray)}function updatePlaylistList(t){playlistList.innerHTML="",t.forEach(((t,e,s)=>{t.trackNumber=(e+1).toString().padStart(s.length.toString().length,"0"),playlistList.insertAdjacentHTML("beforeend",renderTrack(t))}))}function sortByName(t,e){const s=t.trackArtists.localeCompare(e.trackArtists);return 0!==s?s:t.trackName.localeCompare(e.trackName)}function sortByDate(t,e){return t.trackAdded.localeCompare(e.trackAdded)}loginButton.addEventListener("click",(()=>{const t=`https://accounts.spotify.com/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes)}`;window.location.href=t})),logoutButton.addEventListener("click",(()=>{localStorage.removeItem("accessToken");const t=window.open("https://accounts.spotify.com/logout","Spotify Logout","width=500,height=500,top=40,left=40");setTimeout((()=>{t.close(),window.location.href=redirectUri}),2e3)})),window.addEventListener("load",(async()=>{const t=getAccessToken();if(t){playlistList.innerHTML="",libraryOtherPlaylistsList.innerHTML="";const{userName:e,userImage:s}=await getUserProfile(t);document.querySelector(".user__name").textContent=e,s&&(document.querySelector(".user__image").parentElement.outerHTML=s),aside.classList.remove("hidden"),getUserPlaylists(t),await getPlaylistTracks(t)}else login.classList.remove("hidden")})),window.addEventListener("click",(async t=>{if(t.target.closest(".library__playlist-button")&&!t.target.closest(".library__playlist-button.active")&&!t.target.closest(".library__liked-songs-button")&&checkPlaylistButton){checkPlaylistButton=!1;const e=getAccessToken(),s=t.target.closest(".library__playlist-button"),o=s.dataset.playlistId,a=s.querySelector(".library__playlist-name").textContent;document.querySelectorAll(".library__playlist-button").forEach((t=>{t.classList.remove("active")})),s.classList.add("active"),sortContentButtons.forEach((t=>{t.classList.remove("active","reverse")})),sortContentButtonDefault.classList.add("active"),header.classList.add("hidden"),headerPlaylistName.textContent=a,playlistList.innerHTML="",sortArray=[],sortDefaultArray=[],await getPlaylistTracks(e,`playlists/${o}`)}})),likedSongsButton.addEventListener("click",(async()=>{if(likedSongsButton.classList.contains("active")||!checkPlaylistButton)return;checkPlaylistButton=!1;const t=getAccessToken();document.querySelectorAll(".library__playlist-button").forEach((t=>{t.classList.remove("active")})),likedSongsButton.classList.add("active"),sortContentButtons.forEach((t=>{t.classList.remove("active","reverse")})),sortContentButtonDefault.classList.add("active"),header.classList.add("hidden"),headerPlaylistName.textContent=likedSongsButton.textContent,playlistList.innerHTML="",sortArray=[],sortDefaultArray=[],await getPlaylistTracks(t)})),sortContentButtonDefault.addEventListener("click",(()=>{checkPlaylistButton&&!sortContentButtonDefault.classList.contains("active")&&(sortContentButtons.forEach((t=>{t.classList.remove("active","reverse")})),sortContentButtonDefault.classList.add("active"),updatePlaylistList(sortDefaultArray))})),sortContentButtonDate.addEventListener("click",(()=>{sortButtonAction(sortContentButtonDate,sortByDate)})),sortContentButtonName.addEventListener("click",(()=>{sortButtonAction(sortContentButtonName,sortByName)}));const{createFocusTrap:createFocusTrap}=window.focusTrap,focusTrap=createFocusTrap(sortContentPopup,{onActivate:()=>{},onDeactivate:()=>{sortContentPopup.classList.remove("active")},escapeDeactivates:!0,clickOutsideDeactivates:!0});sortButton.addEventListener("keydown",(t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),window.innerWidth<=mediaWidth("107rem")&&aside.classList.contains("active")&&closesAside(),sortContentPopup.classList.add("active"),sortContentPopup.style.top=sortButton.getBoundingClientRect().top+"px",sortContentPopup.style.left=sortButton.offsetWidth+sortButton.getBoundingClientRect().left+10+"px",focusTrap.activate())})),window.addEventListener("load",(()=>{document.body.classList.remove("js-stop-transition")}));